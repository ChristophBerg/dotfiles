#!/bin/sh

PROG=$(basename "$1")
PREFIX="$2"
TLDS="com|de|dmz|lan|nil|net|org"

case $PROG in
    apt-get|agi|agr)
	apt-cache pkgnames "$PREFIX"
	;;

    bibtex)
	ls -d "$PREFIX"*.tex 2> /dev/null | sed -e 's/\.tex$//'
	;;

    complete)
	. ~/.bash_completion
	complete | sed -e 's/.* //'
	;;

    cp|mv)
	# "mv foo <tab>" should expand to "mv foo foo" so we can edit the target name
	[ -z "$2" ] && echo "$3"
	;;

    cvs)
	#sed -e 's|[^/]*/||' -e 's|/.*||' < CVS/Entries | grep -v '^D$'
	PREFIXDIR=`dirname "$PREFIX."`
	ENTRIES="$PREFIXDIR/CVS/Entries"
	[ -f "$ENTRIES" ] || exit 0
	[ $PREFIXDIR != . ] && PRINTDIR="$PREFIXDIR/"
	perl -ne "print \"$PRINTDIR\$1\\n\" if m|^/([^/]+)/|" "$ENTRIES"
	;;

    mailsync)
	egrep '^(channel|store)' ~/.mailsync | cut -d ' ' -f 2
	;;

    make)
	[ -f Makefile ] || exit 0
	perl -ne 'print "$1\n" if /^([^ :]+):/' Makefile
	;;

    man)
	if [ -f $TMP/whatis.cache ] ; then
		egrep "^$PREFIX" $TMP/whatis.cache
	else
		whatis -w "$PREFIX*" | cut -d ' ' -f 1 | grep -v ':$'
	fi
	;;

    mutt)
	MUTT=$HOME/.mutt
	cut -d ' ' -f 2 $MUTT/aliases $MUTT/aliases.addressbook| egrep "^$PREFIX"
	;;

    ssh|mosh)
	[ -f /etc/ssh/ssh_known_hosts ] && ETC_KNOWN_HOSTS=/etc/ssh/ssh_known_hosts
	perl -lne 's/^#| .*|^\[|\].*//g; foreach (split /,/) { print if /\.('"$TLDS"')$/ }' ~/.ssh/known_hosts $ETC_KNOWN_HOSTS
	;;

    scp|rsync)
	[ -f /etc/ssh/ssh_known_hosts ] && ETC_KNOWN_HOSTS=/etc/ssh/ssh_known_hosts
	perl -lne 's/^#| .*|^\[|\].*//g; foreach (split /,/) { print "$_:" if /\.('"$TLDS"')$/ }' ~/.ssh/known_hosts $ETC_KNOWN_HOSTS
	;;

    start|stop|status|reload|restart|enable|disable)
	for f in /etc/init.d/$PREFIX* /lib/systemd/$PREFIX*.service /etc/systemd/system/$PREFIX*.service; do
	    case $f in
		*.dpkg*) ;;
		*) test -f $f && echo $(basename $f .service) ;;
	    esac
	done
	;;

    super)
	cut -f 1 /etc/super.tab | egrep '^[a-z]'
	;;

    *)
	echo "$0: cannot complete program $PROG, prefix $PREFIX" 1>&2
	exit 1
esac

# vim:sw=4:
