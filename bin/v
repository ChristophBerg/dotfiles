#!/bin/sh

# DWIM cvs/svn/whatever wrapper.
# (public domain) 2008, 2009  Christoph Berg <cb@df7cb.de>
# One of the scripts I should have written years ago.

try_vcs_dir ()
{
	dir="$1"
	#echo "Looking in $dir ..."
	if [ -d $dir/.svn ] ; then
		VCS=svn
	elif [ -d $dir/.hg ] ; then
		VCS=hg
	elif [ -d $dir/.git ] ; then
		VCS=git
	elif [ -d $dir/.bzr ] ; then
		VCS=bzr
	elif [ -d $dir/CVS ] ; then
		VCS=cvs
	else
		return 1
	fi
	return 0
}

find_vcs ()
{
	base="$1"
	#echo "Looking from $base ..."
	if try_vcs_dir $base ||
	   try_vcs_dir $base/.. ||
	   try_vcs_dir $base/../.. ||
	   try_vcs_dir $base/../../.. ; then
		echo "$VCS: $dir" 1>&2
		return 0
	fi
	echo "No VCS found" 1>&2
	exit 1
}

command="$1"
test "$command" && shift

for base in "$@" ; do : ; done
test -d "$base" || base="$(dirname "$base")"
test -d "$base" || base="."
find_vcs "$base"

case $command in
	ci|com|commit) case $VCS in
		bzr) bzr $command "$@" && bzr push ;;
		hg) hg $command "$@" && hg push ;;
		git) git commit "$@" && git push ;;
		*) $VCS $command "$@" ;;
	esac ;;
	pull) case $VCS in
		hg) hg pull -u "$@" ;;
		svn) [ "$1" = "-u" ] && shift
		     svn update "$@" ;;
		*) $VCS $command "$@" ;;
	esac ;;
	st|status) case $VCS in
		cvs) cvs update "$@" ;;
		*) $VCS $command "$@" ;;
	esac ;;
	up|update) case $VCS in
		bzr) bzr pull "$@" ;;
		hg) hg pull -u "$@" ;;
		git) git pull "$@" ;;
		*) $VCS $command "$@" ;;
	esac ;;
	diff)
		CAT=cat
		[ -x /usr/bin/colordiff ] && CAT=colordiff
		$VCS $command "$@" | $CAT ;;
	add|co|cp|diff|info|log|mv|push|resolved|revert|rm|"")
		$VCS $command "$@" ;;
	*)	echo "$0: $VCS command '$command' not recognized. YMMV." 1>&2
		$VCS "$command" "$@" ;;
esac
