#!/bin/sh

set -e

DIR=$(mktemp -d -t pluckerXXXXXX)
trap "rm -rf $DIR" 0 2 3 15

FILE="$1"
case $FILE in
	*.zip) BASE=`basename $FILE .zip`
		unzip -d $DIR -o $FILE ;;
	*.gpx) BASE=`basename $FILE .gpx`
		cp $FILE $DIR ;;
	*) echo "unknown extension" ; exit 1 ;;
esac
cd $DIR
if ! [ -e $BASE.gpx ] ; then
	echo "$BASE.gpx not found"
	exit 1
fi

NAME="$2"
[ -z "$NAME" ] && NAME="$BASE"
case $NAME in
	1948628) NAME="Mönchengladbach" ;;
	1948630) NAME="Gefunden von Myon" ;;
	2047388) NAME="Neue Caches" ;;
	2163721) NAME="Berlin" ;;
	2234517) NAME="Myons Caches" ;;
	2234688) NAME="Duisburg" ;;
esac

to_plucker () {
	gpsbabel -c utf-8 -i gpx -f $BASE.gpx -o html,logs -F $BASE-utf8.html
	iconv -c -f utf8 -t latin1 $BASE-utf8.html > $BASE.html || :

	# --url-pattern=$BASE.html --stayondomain
	plucker-build \
	  --doc-name="$NAME" --category="Geocaching" \
	  --charset=utf-8 \
	  --bpp=16 --maxwidth=160 --maxheight=160 --alt-maxwidth=320 --alt-maxheight=320 \
	  --maxdepth=1 \
	  --doc-file=$PWD/$BASE --home-url=$PWD/$BASE.html

	ls -lh $BASE.pdb
	pilot-xfer -D/PALM/programs/Plucker/$BASE.pdb -i $BASE.pdb
}

to_viking () {
	lsmod | grep -q garmin || sudo modprobe garmin_gps

	cat > google.viking <<EOF
#VIKING GPS Data file http://viking.sf.net/

xmpp=4,000000
ympp=4,000000
lat=51,193833
lon=6,424075
mode=mercator
color=#cccccc
drawscale=t
drawcentermark=t
~Layer Map
name=Satellitenkarte
mode=11
directory=
alpha=255
autodownload=t
mapzoom=0
~EndLayer
EOF

	cat > gps.viking <<EOF
#VIKING GPS Data file http://viking.sf.net/

xmpp=4,000000
ympp=4,000000
lat=51,193833
lon=6,424075
mode=mercator
color=#cccccc
drawscale=t
drawcentermark=t
~Layer GPS
name=GPS
gps_protocol=0
gps_port=2
record_tracking=t
center_start_tracking=t
centered_tracking=f
gpsd_host=localhost
gpsd_port=2947

~Layer TrackWaypoint
name=TrackWaypoint
tracks_visible=t
waypoints_visible=t
drawmode=0
drawlines=t
drawpoints=t
drawelevation=f
elevation_factor=30
drawstops=f
stop_length=60
line_thickness=1
bg_line_thickness=0
trackbgcolor=#ffffff
velocity_min=0.000000
velocity_max=5.000000
drawlabels=t
wpcolor=#000000
wptextcolor=#ffffff
wpbgcolor=#8383c4
wpbgand=t
wpsymbol=0
wpsize=4
wpsyms=t
drawimages=t
image_size=64
image_alpha=255
image_cache_size=300


~LayerData
type="waypointlist"
type="waypointlistend"
~EndLayerData
~EndLayer


~Layer TrackWaypoint
name=TrackWaypoint
tracks_visible=t
waypoints_visible=t
drawmode=0
drawlines=t
drawpoints=t
drawelevation=f
elevation_factor=30
drawstops=f
stop_length=60
line_thickness=1
bg_line_thickness=0
trackbgcolor=#ffffff
velocity_min=0.000000
velocity_max=5.000000
drawlabels=t
wpcolor=#000000
wptextcolor=#ffffff
wpbgcolor=#8383c4
wpbgand=t
wpsymbol=0
wpsize=4
wpsyms=t
drawimages=t
image_size=64
image_alpha=255
image_cache_size=300


~LayerData
type="waypointlist"
type="waypointlistend"
~EndLayerData
~EndLayer


~Layer TrackWaypoint
name=TrackWaypoint
tracks_visible=t
waypoints_visible=t
drawmode=0
drawlines=t
drawpoints=t
drawelevation=f
elevation_factor=30
drawstops=f
stop_length=60
line_thickness=1
bg_line_thickness=0
trackbgcolor=#ffffff
velocity_min=0.000000
velocity_max=5.000000
drawlabels=t
wpcolor=#000000
wptextcolor=#ffffff
wpbgcolor=#8383c4
wpbgand=t
wpsymbol=0
wpsize=4
wpsyms=t
drawimages=t
image_size=64
image_alpha=255
image_cache_size=300


~LayerData
type="waypointlist"
type="waypointlistend"
~EndLayerData
~EndLayer

~EndLayer
EOF

	viking google.viking $BASE*.gpx gps.viking
}

to_gps () {
	lsmod | grep -q garmin || sudo modprobe garmin_gps
	gpsbabel -i gpx -f $BASE.gpx -f $BASE-wpts.gpx -o garmin -F /dev/ttyUSB0
}

if test -t 1 ; then
	read -p 'Open with (p)lucker (v)iking (g)ps? ' answer
	case $answer in
		p) to_plucker ;;
		v) to_viking ;;
		g) to_gps ;;
		*) echo "huh?" ; exit 1 ;;
	esac
else
	to_plucker
fi
