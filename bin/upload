#!/bin/sh

set -eu

CLEAN=yes
GIT=git

while getopts "cg" opt ; do
  case $opt in
    c) CLEAN="" ;;
    g) GIT="" ;;
    *) exit 5 ;;
  esac
done
# shift away args
shift $(($OPTIND - 1))

distribution=$(dpkg-parsechangelog -Sdistribution)
if [ "$distribution" = "UNRELEASED" ]; then
  echo "Distribution is UNRELEASED. Fix that before uploading."
  exit 1
fi

[ "$CLEAN" ] && dclean
qpop -a || [ $? = 2 ]

changes=$(ls -t ../*.changes | head -1)
ls -l $changes
echo
cat $changes

echo
[ -d .git ] && git --no-pager status

echo
echo -n "Upload? "
read upload

set -x
if [ "$GIT" ]; then
  git pull --ff-only
  if git status -s | grep -q '^[^?]'; then
    git add -u
    debcommit -r
  fi
  git push
fi
debsign $changes
dput $changes
