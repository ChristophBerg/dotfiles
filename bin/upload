#!/bin/sh

set -eu

CLEAN=yes
GIT=git
PACKAGE=$(dpkg-parsechangelog -SSource)

while getopts "cg" opt ; do
  case $opt in
    c) CLEAN="" ;;
    g) GIT="" ;;
    *) exit 5 ;;
  esac
done
# shift away args
shift $(($OPTIND - 1))

distribution=$(dpkg-parsechangelog -Sdistribution)
if [ "$distribution" = "UNRELEASED" ]; then
  echo "Distribution is UNRELEASED. Fix that before uploading."
  exit 1
fi

[ "$CLEAN" ] && dclean
qpop -a || [ $? = 2 ]
echo

changes=$(ls -t ../*.changes | head -1)
printf '\e[1;34m'
ls -l $changes
printf '\e[0;34m'
cat $changes
printf '\e[0m'

echo
[ -d .git ] && git --no-pager status

# sanity checks
if [ -f debian/source/lintian-overrides ] && grep changelog-should-mention-nmu debian/source/lintian-overrides; then
  printf '\e[1;31mObsolete lintian overrides found\e[0m\n'
fi
if grep -q postgres debian/control* && ! grep -q Rules-Requires-Root debian/control; then
  printf '\e[1;31mRules-Requires-Root: no missing\e[0m\n'
fi
if [ ! -f debian/gitlab-ci.yml ] && [ ! -f debian/salsa-ci.yml ]; then
  printf '\e[1;31mNo debian/gitlab-ci.yml found\e[0m\n'
fi
case $changes in
  *_source*) ;;
  *) printf '\e[1;31mArchitecture-dependant changes file\e[0m\n'
     ;;
esac

export GPG_TTY="$(tty)"
gpg-connect-agent updatestartuptty /bye > /dev/null

if [ "$GIT" ]; then
  echo
  echo -n "$PACKAGE: Push? "
  read push

  grep '^Vcs-Browser' debian/control || :
  grep -q postgres debian/control* && printf "\e[1mhttps://pgdgbuild.dus.dg-i.net/job/$PACKAGE/build\e[0m\n"

  echo -n "git pull ... "
  git pull --ff-only

  if git status -s | grep -q '^[^?]'; then
    git add -u debian
    debcommit -r --release-use-changelog
  fi

  BRANCHES=$(git branch | grep '^\*' | cut -d ' ' -f 2)
  for branch in upstream pristine-tar; do
    if git branch | grep -qw $branch; then
      BRANCHES="$BRANCHES $branch"
    fi
  done
  echo -n "git npush origin $BRANCHES ... "
  git npush origin $BRANCHES
fi

echo
echo -n "$PACKAGE: Upload? "
read upload

if [ "$GIT" ]; then
  echo -n "git push ... "
  git push
fi
set -x
debsign $changes
dput $changes
